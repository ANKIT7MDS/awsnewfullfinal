<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer">
  <title>Wedding Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #1f2937; }
    .masonry-grid { column-count: 2; column-gap: 1rem; }
    @media (min-width: 768px) { .masonry-grid { column-count: 3; } }
    @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }
    
    .photo-item { break-inside: avoid; margin-bottom: 1rem; position: relative; border-radius: 0.5rem; overflow: hidden; transition: transform 0.2s; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .photo-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .photo-item:hover .overlays { opacity: 1; }
    .overlays { opacity: 0; transition: opacity 0.2s; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

  <!-- Loading State -->
  <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
    <p class="text-gray-500 text-sm font-medium">Loading Gallery...</p>
  </div>

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex flex-col">
        <h1 id="collectionTitle" class="text-lg font-bold text-gray-900 leading-tight">...</h1>
        <p id="photoStats" class="text-xs text-gray-500">Loading...</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="saveStatus" class="hidden text-xs font-medium text-green-600 flex items-center gap-1"><i class="fa fa-check-circle"></i> Saved</div>
        <button onclick="downloadSelection()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
          <i class="fa fa-download mr-1"></i> Download
        </button>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-gray-50 border-b border-gray-200 py-3 overflow-x-auto no-scrollbar">
      <div class="max-w-7xl mx-auto px-4 flex items-center gap-4">
        <div class="flex items-center gap-2 border-r border-gray-300 pr-4">
          <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Events</span>
          <div id="eventFilters" class="flex gap-2"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Grid -->
  <main class="flex-grow p-4 bg-gray-50">
    <div id="galleryGrid" class="max-w-7xl mx-auto masonry-grid"></div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col">
    <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center text-white z-10 bg-gradient-to-b from-black/50 to-transparent">
      <span class="text-sm font-medium"><span id="lbCurrent">1</span> / <span id="lbTotal">10</span></span>
      <button onclick="closeLightbox()" class="p-2 hover:bg-white/10 rounded-full"><i class="fa fa-times text-xl"></i></button>
    </div>
    <div class="flex-grow flex items-center justify-center relative overflow-hidden">
      <button onclick="prevPhoto()" class="absolute left-4 p-4 text-white hover:bg-white/10 rounded-full z-20"><i class="fa fa-chevron-left text-2xl"></i></button>
      <img id="lbImage" src="" referrerpolicy="no-referrer" class="max-h-[85vh] max-w-[95vw] object-contain shadow-2xl rounded-sm transition-transform duration-300">
      <button onclick="nextPhoto()" class="absolute right-4 p-4 text-white hover:bg-white/10 rounded-full z-20"><i class="fa fa-chevron-right text-2xl"></i></button>
    </div>
    <div class="h-20 bg-white border-t border-gray-800 flex items-center justify-center gap-8 pb-4 pt-2">
        <button id="lbFavBtn" onclick="toggleAction('fav')" class="flex flex-col items-center gap-1 text-gray-500 hover:text-red-500 transition">
            <i class="far fa-heart text-2xl"></i><span class="text-[10px] font-medium">Select</span>
        </button>
    </div>
  </div>

  <script>
    const API_URL = "https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod/client-api";
    const urlParams = new URLSearchParams(window.location.search);
    const COLLECTION_ID = urlParams.get('cid');
    let state = { allPhotos: [], filteredPhotos: [], currentEvent: 'all', idx: 0 };

    async function init() {
      if(!COLLECTION_ID) return document.body.innerHTML = "<div class='p-10 text-center'>No Collection ID</div>";
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'get_client_view', payload: { collection_id: COLLECTION_ID } })
        });
        const data = await res.json();
        state.allPhotos = data.photos || [];
        document.getElementById('collectionTitle').innerText = data.collection_name || "Wedding Gallery";
        applyFilters();
        renderFilters();
        document.getElementById('loader').style.display = 'none';
      } catch(e) { alert("Error loading gallery"); console.error(e); }
    }

    function renderFilters() {
      const events = ['all', ...new Set(state.allPhotos.map(p => p.event || 'Main Event'))];
      const evContainer = document.getElementById('eventFilters');
      evContainer.innerHTML = events.map(ev => `
        <button onclick="setEvent('${ev}')" 
          class="px-3 py-1 rounded-full text-xs font-medium border transition ${state.currentEvent === ev ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-400'}">
          ${ev === 'all' ? 'All' : ev}
        </button>
      `).join('');
    }

    window.setEvent = (ev) => { state.currentEvent = ev; applyFilters(); renderFilters(); };

    function applyFilters() {
      state.filteredPhotos = state.allPhotos.filter(p => state.currentEvent === 'all' || (p.event || 'Main Event') === state.currentEvent);
      renderGrid();
      updateStats();
    }

    function renderGrid() {
      const grid = document.getElementById('galleryGrid');
      if(state.filteredPhotos.length === 0) {
          grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400">No photos found.</div>`;
          return;
      }
      grid.innerHTML = state.filteredPhotos.map((p, i) => {
        // Robust src finding
        let src = p.thumbnail_url || p.thumb || p.url;
        if(src && src.startsWith('http://')) src = src.replace('http://', 'https://');
        if(!src) src = 'https://via.placeholder.com/400?text=No+Link';

        return `
        <div class="photo-item group cursor-pointer" onclick="openLightbox(${i})">
          <img src="${src}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-auto block" onerror="this.src='https://via.placeholder.com/400?text=Error'">
          <div class="absolute inset-0 overlays p-2 flex flex-col justify-between">
            <div class="flex justify-end gap-2">
               ${p.status?.fav ? '<span class="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md"><i class="fa fa-heart"></i></span>' : ''}
            </div>
          </div>
        </div>
      `}).join('');
    }

    function updateStats() {
      const selected = state.allPhotos.filter(p => p.status?.fav).length;
      document.getElementById('photoStats').innerText = `${state.allPhotos.length} Photos â€¢ ${selected} Selected`;
    }

    window.openLightbox = (i) => {
      state.idx = i;
      updateLightbox();
      document.getElementById('lightbox').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };

    window.closeLightbox = () => {
      document.getElementById('lightbox').classList.add('hidden');
      document.body.style.overflow = 'auto';
      renderGrid();
    };

    function updateLightbox() {
      const p = state.filteredPhotos[state.idx];
      let src = p.url || p.thumbnail_url || p.thumb;
      if(src && src.startsWith('http://')) src = src.replace('http://', 'https://');
      
      document.getElementById('lbImage').src = src;
      document.getElementById('lbCurrent').innerText = state.idx + 1;
      document.getElementById('lbTotal').innerText = state.filteredPhotos.length;
      
      const favBtn = document.getElementById('lbFavBtn');
      if(p.status?.fav) favBtn.innerHTML = '<i class="fas fa-heart text-2xl text-red-500"></i><span class="text-[10px] font-medium text-red-500">Selected</span>';
      else favBtn.innerHTML = '<i class="far fa-heart text-2xl"></i><span class="text-[10px] font-medium">Select</span>';
    }

    window.nextPhoto = () => { if(state.idx < state.filteredPhotos.length - 1) { state.idx++; updateLightbox(); } };
    window.prevPhoto = () => { if(state.idx > 0) { state.idx--; updateLightbox(); } };

    window.toggleAction = async (type) => {
      const p = state.filteredPhotos[state.idx];
      if(!p.status) p.status = {};
      if(type === 'fav') p.status.fav = !p.status.fav;
      updateLightbox();
      updateStats();
      const statusEl = document.getElementById('saveStatus');
      statusEl.classList.remove('hidden');
      try {
        await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'update_selection', payload: { collection_id: COLLECTION_ID, photo_id: p.id, status: p.status } })
        });
        setTimeout(() => statusEl.classList.add('hidden'), 2000);
      } catch(e) { console.error(e); }
    };

    window.downloadSelection = () => {
       alert("Batch download blocked by browser security. Please right click images to save.");
    };

    init();
  </script>
</body>
</html>