<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€¢ EventLens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Navigation & Sidebar */
        .nav-item { @apply flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-100 hover:text-indigo-600 transition-all cursor-pointer; }
        .nav-item.active { @apply bg-indigo-50 text-indigo-700 shadow-sm ring-1 ring-indigo-200; }
        
        /* Buttons */
        .btn { @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all; }
        .btn-primary { @apply border-transparent text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 shadow-indigo-100; }
        .btn-secondary { @apply border-slate-300 text-slate-700 bg-white hover:bg-slate-50 focus:ring-indigo-500; }
        .btn-danger { @apply border-transparent text-white bg-red-600 hover:bg-red-700 focus:ring-red-500; }
        
        /* Layouts */
        .hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tabs */
        .tab-btn { @apply pb-3 px-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors; }
        .tab-btn.active { @apply border-indigo-600 text-indigo-600; }

        /* Photo Grid */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .photo-card { @apply relative aspect-[4/3] bg-slate-100 rounded-lg overflow-hidden border border-slate-200 group transition-all hover:shadow-lg hover:-translate-y-1 cursor-pointer; }
        .photo-card img { @apply w-full h-full object-cover transition-transform duration-500 group-hover:scale-105; }
        .photo-overlay { @apply absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3; }
        
        /* Table Styles */
        .table-container { @apply overflow-x-auto rounded-lg border border-slate-200 bg-white shadow-sm; }
        .table-head { @apply bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3 text-left; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-slate-700; }

        /* Card */
        .card { @apply bg-white rounded-xl border border-slate-200 shadow-sm p-6; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-slate-100">
             <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold mr-3 shadow-lg shadow-indigo-200">E</div>
             <span class="font-bold text-lg tracking-tight text-slate-800">EventLens</span>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-1">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-3 mt-2">Workspace</div>
            <div onclick="router('collections')" class="nav-item active" id="nav-collections">
                <i class="fas fa-folder-open w-5 text-center"></i> Collections
            </div>
            <div onclick="router('account')" class="nav-item" id="nav-account">
                <i class="fas fa-sliders-h w-5 text-center"></i> Settings
            </div>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50/50">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 p-[2px] shadow-sm">
                    <div class="w-full h-full rounded-full bg-white flex items-center justify-center text-indigo-700 font-bold text-xs" id="userAvatar">U</div>
                </div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold text-slate-700 truncate" id="userName">User</p>
                    <p class="text-xs text-slate-500">Pro Plan</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full btn btn-secondary text-xs h-9">
                <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 bg-slate-50">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 text-white w-7 h-7 rounded flex items-center justify-center font-bold text-sm">E</div>
                <span class="font-bold text-slate-800">EventLens</span>
            </div>
            <button onclick="logout()" class="text-slate-500"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Dynamic View Area -->
        <main class="flex-1 overflow-y-auto" id="main-container">
            
            <!-- VIEW: COLLECTIONS LIST -->
            <div id="view-collections" class="view-section p-6 md:p-10 max-w-7xl mx-auto hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Collections</h1>
                        <p class="text-sm text-slate-500 mt-1">Manage all your client events and galleries.</p>
                    </div>
                    <button onclick="openModal('createCollectionModal')" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i> New Collection
                    </button>
                </div>

                <!-- Empty State -->
                <div id="emptyCollections" class="hidden flex flex-col items-center justify-center py-24 bg-white rounded-xl border-2 border-slate-200 border-dashed">
                    <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 text-3xl mb-4 shadow-inner"><i class="fas fa-images"></i></div>
                    <h3 class="text-lg font-bold text-slate-900">No collections yet</h3>
                    <p class="text-slate-500 text-sm mb-6 max-w-xs text-center">Create your first collection to start uploading and sharing photos.</p>
                    <button onclick="openModal('createCollectionModal')" class="btn btn-secondary">Create Collection</button>
                </div>

                <!-- List -->
                <div id="collectionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>

            <!-- VIEW: COLLECTION DETAILS -->
            <div id="view-details" class="view-section hidden h-full flex flex-col">
                
                <!-- Detail Header -->
                <div class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm px-6 pt-6 pb-0">
                    <div class="max-w-7xl mx-auto">
                        <!-- Top Row: Breadcrumbs & Actions -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div class="flex items-center gap-4">
                                <button onclick="router('collections')" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition border border-slate-200">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <div>
                                    <h1 class="text-2xl font-bold text-slate-900 leading-tight" id="detailName">...</h1>
                                    <div class="flex items-center gap-4 text-xs font-medium text-slate-500 mt-1">
                                        <span class="flex items-center gap-1.5"><i class="fas fa-images text-indigo-500"></i> <span id="detailCount">0</span> Photos</span>
                                        <span class="flex items-center gap-1.5 hidden md:flex"><i class="fas fa-users text-indigo-500"></i> <span id="detailLeads">0</span> Leads</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openClientGallery()" class="btn btn-secondary text-xs md:text-sm"><i class="fas fa-external-link-alt md:mr-2"></i> <span class="hidden md:inline">View</span></button>
                                <button onclick="openModal('uploadModal')" class="btn btn-primary text-xs md:text-sm"><i class="fas fa-cloud-upload-alt md:mr-2"></i> Upload</button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="flex gap-6 overflow-x-auto no-scrollbar">
                            <button onclick="switchDetailTab('photos')" class="tab-btn active" id="tab-photos"><i class="far fa-images mr-1"></i> Photos</button>
                            <button onclick="switchDetailTab('events')" class="tab-btn" id="tab-events"><i class="far fa-calendar-alt mr-1"></i> Events</button>
                            <button onclick="switchDetailTab('links')" class="tab-btn" id="tab-links"><i class="fas fa-link mr-1"></i> Links</button>
                            <button onclick="switchDetailTab('analytics')" class="tab-btn" id="tab-analytics"><i class="fas fa-chart-line mr-1"></i> Analytics</button>
                        </div>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div class="flex-1 overflow-y-auto p-6 md:p-8">
                    <div class="max-w-7xl mx-auto space-y-8">
                        
                        <!-- TAB: PHOTOS -->
                        <div id="content-photos" class="tab-content block space-y-6">
                            <!-- Filters -->
                            <div class="card flex flex-col md:flex-row gap-4 items-center justify-between p-4">
                                <div class="flex items-center gap-2 text-slate-500 font-medium">
                                    <i class="fas fa-filter"></i> <span class="hidden md:inline">Filters</span>
                                </div>
                                <div class="flex flex-wrap gap-3 flex-1 justify-end">
                                    <select id="filterEvent" class="bg-slate-50 border border-slate-200 text-sm rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="">All Events</option>
                                    </select>
                                    <button class="btn btn-secondary text-xs" onclick="downloadAllPhotos()"><i class="fas fa-download mr-1"></i> Zip</button>
                                </div>
                            </div>

                            <!-- Grid -->
                            <div id="detailPhotosGrid" class="photo-grid"></div>
                            
                            <!-- Loading/Empty -->
                            <div id="detailLoading" class="hidden py-20 text-center">
                                <i class="fas fa-circle-notch fa-spin text-3xl text-indigo-500"></i>
                                <p class="text-slate-500 mt-2">Loading content...</p>
                            </div>
                            <div id="detailEmpty" class="hidden py-20 text-center bg-white rounded-xl border border-dashed border-slate-300">
                                <div class="text-slate-300 text-4xl mb-4"><i class="fas fa-cloud-upload-alt"></i></div>
                                <p class="text-slate-500 mb-4">No photos found.</p>
                                <button onclick="openModal('uploadModal')" class="text-indigo-600 font-semibold hover:underline">Upload Photos</button>
                            </div>
                        </div>

                        <!-- TAB: EVENTS -->
                        <div id="content-events" class="tab-content hidden space-y-6">
                            <div class="flex justify-between items-center">
                                <h2 class="text-lg font-bold text-slate-800">Sub-Events</h2>
                                <button onclick="openModal('eventModal')" class="btn btn-primary text-xs"><i class="fas fa-plus mr-1"></i> Add Event</button>
                            </div>
                            <div class="table-container">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="table-head">Event Name</th>
                                            <th class="table-head">Photos</th>
                                            <th class="table-head text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="eventsList" class="divide-y divide-slate-100 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TAB: LINKS -->
                        <div id="content-links" class="tab-content hidden max-w-2xl mx-auto space-y-6">
                            <div class="card">
                                <h2 class="text-lg font-bold text-slate-800 mb-4">Generate Search Link</h2>
                                <p class="text-sm text-slate-500 mb-6">Create a unique link for a specific sub-event to share with specific guests.</p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Select Event</label>
                                        <select id="linkEventSelect" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                            <option value="">Choose an event...</option>
                                        </select>
                                    </div>
                                    <button onclick="generateLink()" class="btn btn-primary w-full">Generate Link</button>
                                    
                                    <div id="linkResult" class="hidden p-4 bg-slate-50 rounded-lg border border-slate-200 mt-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Shareable Link</label>
                                        <div class="flex gap-2 mt-2">
                                            <input type="text" id="generatedLinkInput" readonly class="flex-1 text-sm bg-white border border-slate-200 rounded px-3 py-2 text-slate-600 select-all">
                                            <button onclick="copyGeneratedLink()" class="btn btn-secondary"><i class="fas fa-copy"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: ANALYTICS -->
                        <div id="content-analytics" class="tab-content hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="card p-4">
                                    <div class="text-slate-500 text-xs font-bold uppercase mb-2">Total Leads</div>
                                    <div class="text-2xl font-bold text-slate-800" id="statLeads">0</div>
                                </div>
                                <div class="card p-4">
                                    <div class="text-slate-500 text-xs font-bold uppercase mb-2">Total Downloads</div>
                                    <div class="text-2xl font-bold text-slate-800" id="statDownloads">0</div>
                                </div>
                                <div class="card p-4">
                                    <div class="text-slate-500 text-xs font-bold uppercase mb-2">Storage Used</div>
                                    <div class="text-2xl font-bold text-slate-800" id="statStorage">0 MB</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <!-- VIEW: ACCOUNT -->
            <div id="view-account" class="view-section hidden p-10 max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-slate-900 mb-6">Account Settings</h1>
                <div class="card text-center py-12">
                    <i class="fas fa-tools text-4xl text-slate-300 mb-4"></i>
                    <h3 class="font-bold text-slate-800">Coming Soon</h3>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Create Collection Modal -->
    <div id="createCollectionModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">New Collection</h3>
                <button onclick="closeModal('createCollectionModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
                    <input type="text" id="newCollectionName" class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="closeModal('createCollectionModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="createCollection()" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Sub-Event Modal -->
    <div id="eventModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Add Sub-Event</h3>
                <button onclick="closeModal('eventModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Event Name</label>
                    <input type="text" id="subEventName" placeholder="e.g. Reception" class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="closeModal('eventModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="createSubEvent()" class="btn btn-primary">Add Event</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col animate-fade-in">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-slate-800">Upload Photos</h3>
                <button onclick="closeModal('uploadModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Dropzone -->
                <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-10 text-center hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer mb-6 group">
                    <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-500 text-3xl mx-auto mb-4 group-hover:scale-110 transition"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p class="font-bold text-slate-800">Click or Drag & Drop Photos</p>
                    <p class="text-sm text-slate-500 mt-1">Supports JPG, PNG, HEIC</p>
                    <input type="file" id="fileInput" multiple accept="image/*,.heic" class="hidden">
                </div>

                <!-- Event Selector for Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Assign to Event</label>
                    <select id="uploadEventSelect" class="w-full border-slate-300 rounded-lg p-2 text-sm border">
                        <option value="">Main Collection (Default)</option>
                    </select>
                </div>

                <!-- List -->
                <div id="uploadList" class="space-y-2"></div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center shrink-0">
                <span class="text-sm font-medium text-slate-600" id="uploadStatus">Ready</span>
                <button id="startUploadBtn" onclick="startUpload()" class="btn btn-primary disabled:opacity-50" disabled>Start Upload</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-24 opacity-0 transition-all duration-300 z-[100] flex items-center gap-3">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toastMsg" class="font-medium text-sm">Success</span>
    </div>

<script>
    // --- Config ---
    const API_BASE = 'https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod';
    const COGNITO_DOMAIN = "https://ap-south-1mva8s6f3w.auth.ap-south-1.amazoncognito.com";
    const CLIENT_ID = "6j3gec3kk0q0ktkals8cr8s367";
    const REDIRECT_URI = window.location.origin + "/dashboard.html";
    
    // --- State ---
    let idToken = localStorage.getItem('idToken');
    let collections = [];
    let currentCollection = null;
    let currentPhotos = [];
    let uploadQueue = [];

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Auth Flow
        const code = new URLSearchParams(window.location.search).get('code');
        if(code) {
            try {
                const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({ grant_type: 'authorization_code', client_id: CLIENT_ID, code, redirect_uri: REDIRECT_URI })
                });
                const data = await res.json();
                if(data.id_token) {
                    idToken = data.id_token;
                    localStorage.setItem('idToken', idToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch(e) {}
        }

        if(!idToken) return window.location.href = 'login.html';
        
        try {
            const payload = JSON.parse(atob(idToken.split('.')[1]));
            document.getElementById('userName').innerText = payload.email.split('@')[0];
            document.getElementById('userAvatar').innerText = payload.email.charAt(0).toUpperCase();
        } catch(e) {}

        // Initial Route
        router('collections');

        // Setup Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-50'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-indigo-500', 'bg-indigo-50'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-50'); handleFiles(e.dataTransfer.files); });
    });

    // --- Routing ---
    window.router = function(view, id) {
        // Safe check for elements before access
        const views = ['collections', 'details', 'account'];
        views.forEach(v => {
            const el = document.getElementById(`view-${v}`);
            const nav = document.getElementById(`nav-${v}`);
            if(el) el.classList.add('hidden');
            if(nav) nav.classList.remove('active');
        });

        const target = document.getElementById(`view-${view}`);
        const nav = document.getElementById(`nav-${view}`);
        
        if(target) target.classList.remove('hidden');
        if(nav) nav.classList.add('active');

        if(view === 'details' && id) {
            loadCollectionDetails(id);
        } else if (view === 'collections') {
            loadCollections();
        }
    };

    window.switchDetailTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`content-${tab}`).classList.remove('hidden');

        if(tab === 'events') loadSubEvents();
        if(tab === 'analytics') loadAnalytics();
        if(tab === 'links') loadLinkOptions();
    };

    // --- Collections ---
    async function loadCollections() {
        const list = document.getElementById('collectionsList');
        const empty = document.getElementById('emptyCollections');
        list.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-circle-notch fa-spin text-indigo-500"></i> Loading...</div>';
        
        try {
            const res = await fetch(`${API_BASE}/get-collections`, { headers: { Authorization: `Bearer ${idToken}` } });
            const data = await res.json();
            collections = data.Items || [];

            if(collections.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                list.innerHTML = collections.map(c => `
                    <div onclick="router('details', '${c.collection_id}')" class="bg-white rounded-xl border border-slate-200 p-5 hover:shadow-lg transition cursor-pointer group hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-lg group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 font-medium">${c.total_photo_count || 0} Photos</span>
                        </div>
                        <h3 class="font-bold text-slate-900 truncate">${c.name}</h3>
                        <p class="text-sm text-slate-500 mt-1">${new Date(c.created_at).toLocaleDateString()}</p>
                    </div>
                `).join('');
            }
        } catch(e) {
            console.error(e);
            list.innerHTML = '<div class="text-red-500 col-span-full text-center">Failed to load data</div>';
        }
    }

    async function createCollection() {
        const name = document.getElementById('newCollectionName').value;
        if(!name) return showToast('Name is required');
        
        try {
            await fetch(`${API_BASE}/upsert-collection`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            closeModal('createCollectionModal');
            showToast('Collection created');
            loadCollections();
        } catch(e) { showToast('Creation failed'); }
    }

    // --- Details ---
    async function loadCollectionDetails(id) {
        currentCollection = collections.find(c => c.collection_id === id);
        if(!currentCollection) return router('collections');

        document.getElementById('detailName').innerText = currentCollection.name;
        document.getElementById('detailCount').innerText = currentCollection.total_photo_count || 0;
        
        switchDetailTab('photos');
        loadPhotos();
    }

    async function loadPhotos() {
        const grid = document.getElementById('detailPhotosGrid');
        const loader = document.getElementById('detailLoading');
        const empty = document.getElementById('detailEmpty');
        
        grid.innerHTML = '';
        grid.classList.add('hidden');
        empty.classList.add('hidden');
        loader.classList.remove('hidden');

        try {
            const res = await fetch(`${API_BASE}/client-api`, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_client_view', payload: { collection_id: currentCollection.collection_id } })
            });
            const data = await res.json();
            currentPhotos = data.photos || [];

            loader.classList.add('hidden');
            if(currentPhotos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                renderPhotoGrid(currentPhotos);
            }
            populateEventFilter();
        } catch(e) {
            loader.classList.add('hidden');
            empty.classList.remove('hidden');
        }
    }

    function renderPhotoGrid(photos) {
        const grid = document.getElementById('detailPhotosGrid');
        grid.innerHTML = photos.map(p => {
             const thumb = p.thumb ? p.thumb.replace('http://', 'https://') : (p.url || 'https://via.placeholder.com/300');
             return `
                <div class="photo-card">
                    <img src="${thumb}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/300?text=Error';">
                    <div class="photo-overlay">
                        <span class="text-xs bg-black/50 text-white px-2 py-1 rounded inline-block w-max">${p.event || 'Main'}</span>
                    </div>
                </div>
             `;
        }).join('');
    }

    // --- Sub-Events ---
    async function loadSubEvents() {
        const tbody = document.getElementById('eventsList');
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        
        if(events.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-500 text-sm">No events found. Upload photos to create events.</td></tr>';
            return;
        }

        tbody.innerHTML = events.map(ev => `
            <tr class="table-row">
                <td class="table-cell font-medium">${ev}</td>
                <td class="table-cell">${currentPhotos.filter(p => (p.event || 'Main Event') === ev).length}</td>
                <td class="table-cell text-right">
                    <button class="text-slate-400 hover:text-slate-600 text-xs" onclick="showToast('Manage in Upload')">Manage</button>
                </td>
            </tr>
        `).join('');
    }

    async function createSubEvent() {
        const name = document.getElementById('subEventName').value;
        if(name) {
            // In a real app we would create a DB entry. Here we simulate availability for the upload dropdown.
            showToast(`Event "${name}" ready for uploads`);
            closeModal('eventModal');
            // Force refresh of upload dropdowns if open
            const select = document.getElementById('uploadEventSelect');
            if(select) {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                select.appendChild(opt);
                select.value = name;
            }
        }
    }

    // --- Links ---
    function loadLinkOptions() {
        const select = document.getElementById('linkEventSelect');
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        select.innerHTML = '<option value="">All Events</option>' + events.map(e => `<option value="${e}">${e}</option>`).join('');
    }

    function generateLink() {
        const evt = document.getElementById('linkEventSelect').value;
        const link = `${window.location.origin}/index.html?cid=${currentCollection.collection_id}${evt ? '&event='+encodeURIComponent(evt) : ''}`;
        document.getElementById('generatedLinkInput').value = link;
        document.getElementById('linkResult').classList.remove('hidden');
    }

    function copyGeneratedLink() {
        const input = document.getElementById('generatedLinkInput');
        input.select();
        document.execCommand('copy');
        showToast('Link copied!');
    }

    // --- Analytics ---
    function loadAnalytics() {
        // Mock Data
        document.getElementById('statLeads').innerText = Math.floor(Math.random() * 50); 
        const size = currentPhotos.reduce((a,b) => a + (b.size || 1024*1024*2), 0);
        document.getElementById('statStorage').innerText = formatBytes(size);
        document.getElementById('statDownloads').innerText = Math.floor(Math.random() * 200);
    }

    // --- Upload ---
    function handleFiles(files) {
        if(!files.length) return;
        
        // Populate Upload Event Select from existing photos + default
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        const select = document.getElementById('uploadEventSelect');
        // Keep existing options if user added new ones via modal, otherwise reset
        if(select.options.length <= 1) {
             select.innerHTML = '<option value="">Main Collection</option>' + events.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        Array.from(files).forEach(file => {
            uploadQueue.push({ file, status: 'pending', id: Math.random().toString(36).substr(2,9) });
        });
        renderUploadList();
    }

    function renderUploadList() {
        const list = document.getElementById('uploadList');
        const btn = document.getElementById('startUploadBtn');
        document.getElementById('uploadStatus').innerText = `${uploadQueue.length} files queued`;
        btn.disabled = uploadQueue.length === 0;

        list.innerHTML = uploadQueue.map(item => `
            <div class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 text-sm">
                <span class="truncate max-w-[200px] text-slate-600">${item.file.name}</span>
                <span class="${item.status === 'done' ? 'text-green-600' : 'text-slate-400'}">
                    ${item.status === 'pending' ? '<i class="far fa-clock"></i>' : 
                      item.status === 'converting' ? '<i class="fas fa-cog fa-spin text-orange-500"></i>' :
                      item.status === 'uploading' ? '<i class="fas fa-spinner fa-spin text-indigo-500"></i>' : 
                      '<i class="fas fa-check"></i>'}
                </span>
            </div>
        `).join('');
    }

    async function startUpload() {
        const btn = document.getElementById('startUploadBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";
        const evt = document.getElementById('uploadEventSelect').value;

        for(let item of uploadQueue) {
            if(item.status !== 'pending') continue;
            
            let fileToUpload = item.file;
            let filename = item.file.name;
            let contentType = item.file.type;

            // HEIC Conversion
            if(filename.toLowerCase().endsWith('.heic')) {
                item.status = 'converting';
                renderUploadList();
                try {
                    const blob = await heic2any({ blob: item.file, toType: "image/jpeg", quality: 0.8 });
                    fileToUpload = blob;
                    filename = filename.replace(/\.heic$/i, ".jpg");
                    contentType = "image/jpeg";
                } catch(e) {
                    console.error("HEIC Error", e);
                    item.status = 'error';
                    renderUploadList();
                    continue;
                }
            }

            item.status = 'uploading';
            renderUploadList();

            try {
                // Get URL
                const pre = await fetch(`${API_BASE}/get-upload-url`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        collection_id: currentCollection.collection_id, 
                        filename: filename, 
                        content_type: contentType,
                        event: evt 
                    })
                });
                
                if(!pre.ok) throw new Error("Pre-sign failed");
                const { upload_url } = await pre.json();
                
                // Upload to S3
                await fetch(upload_url, { method: 'PUT', headers: { 'Content-Type': contentType }, body: fileToUpload });
                item.status = 'done';
            } catch(e) {
                console.error(e);
                item.status = 'error';
            }
            renderUploadList();
        }

        btn.innerText = "Done";
        setTimeout(() => {
            closeModal('uploadModal');
            uploadQueue = [];
            renderUploadList();
            btn.innerText = "Start Upload";
            loadPhotos(); // Refresh grid
        }, 1000);
    }

    // --- Downloads ---
    async function downloadAllPhotos() {
        if(currentPhotos.length === 0) return showToast("No photos to download");
        
        const zip = new JSZip();
        const folder = zip.folder(currentCollection.name || "Photos");
        let count = 0;
        
        showToast("Preparing Zip...");
        
        // Limit to first 20 for demo/performance in browser
        const limit = Math.min(currentPhotos.length, 20); 
        
        for(let i=0; i<limit; i++) {
            const p = currentPhotos[i];
            const url = p.url; // Ensure CORS allows fetching
            if(url) {
                try {
                    const blob = await fetch(url).then(r => r.blob());
                    folder.file(`photo_${i+1}.jpg`, blob);
                    count++;
                } catch(e) { console.error("Zip fetch error", e); }
            }
        }
        
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, `${currentCollection.name}.zip`);
            showToast("Download started!");
        });
    }

    // --- Helpers ---
    function populateEventFilter() {
        const select = document.getElementById('filterEvent');
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        select.innerHTML = '<option value="">All Events</option>' + events.map(e => `<option value="${e}">${e}</option>`).join('');
        
        select.onchange = () => {
            const val = select.value;
            if(!val) renderPhotoGrid(currentPhotos);
            else renderPhotoGrid(currentPhotos.filter(p => (p.event || 'Main Event') === val));
        };
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.showToast = (msg) => {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.remove('translate-y-24', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
    };
    window.openClientGallery = () => {
        if(currentCollection) window.open(`index.html?cid=${currentCollection.collection_id}`, '_blank');
    };
    window.copyShareLink = () => {
        if(!currentCollection) return;
        const url = `${window.location.origin}/index.html?cid=${currentCollection.collection_id}`;
        navigator.clipboard.writeText(url);
        showToast('Gallery Link Copied!');
    };
</script>
</body>
</html>