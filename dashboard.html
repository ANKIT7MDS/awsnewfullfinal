<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€¢ EventLens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; color: #111827; }
        
        /* Navigation & Sidebar */
        .nav-item { @apply flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-indigo-600 transition-colors cursor-pointer; }
        .nav-item.active { @apply bg-indigo-50 text-indigo-700; }
        
        /* Buttons */
        .btn { @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all; }
        .btn-primary { @apply border-transparent text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500; }
        .btn-white { @apply border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500; }
        
        /* Layouts */
        .view-section { @apply animate-fade-in; }
        .hidden { display: none !important; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }

        /* Photo Grid */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .photo-card { @apply relative aspect-[4/3] bg-gray-100 rounded-lg overflow-hidden border border-gray-200 group transition-shadow hover:shadow-md; }
        .photo-card img { @apply w-full h-full object-cover transition-transform duration-500 group-hover:scale-105; }
        .photo-actions { @apply absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
             <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold mr-3">E</div>
             <span class="font-bold text-lg tracking-tight">EventLens</span>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-1">
            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-3">Main</div>
            <div onclick="router('collections')" class="nav-item active" id="nav-collections">
                <i class="fas fa-folder w-5 text-center"></i> Collections
            </div>
            <div onclick="router('account')" class="nav-item" id="nav-account">
                <i class="fas fa-user-cog w-5 text-center"></i> Settings
            </div>
        </div>

        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs" id="userAvatar">U</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium text-gray-900 truncate" id="userName">User</p>
                    <p class="text-xs text-gray-500">Free Plan</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full btn btn-white text-xs">Sign Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 bg-white">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4">
            <span class="font-bold text-lg">EventLens</span>
            <button class="text-gray-500"><i class="fas fa-bars"></i></button>
        </header>

        <!-- Dynamic View Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50/50">
            
            <!-- VIEW: COLLECTIONS LIST -->
            <div id="view-collections" class="view-section p-8 max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Collections</h1>
                        <p class="text-sm text-gray-500 mt-1">Manage your client galleries</p>
                    </div>
                    <button onclick="openModal('createCollectionModal')" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i> New Collection
                    </button>
                </div>

                <!-- Empty State -->
                <div id="emptyCollections" class="hidden flex flex-col items-center justify-center py-20 bg-white rounded-xl border border-gray-200 border-dashed">
                    <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 text-2xl mb-4"><i class="far fa-folder-open"></i></div>
                    <h3 class="text-lg font-medium text-gray-900">No collections yet</h3>
                    <p class="text-gray-500 text-sm mb-6">Create your first collection to start uploading photos.</p>
                    <button onclick="openModal('createCollectionModal')" class="btn btn-white">Create Collection</button>
                </div>

                <!-- List -->
                <div id="collectionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- VIEW: COLLECTION DETAILS -->
            <div id="view-details" class="view-section hidden h-full flex flex-col">
                
                <!-- Detail Header -->
                <div class="bg-white border-b border-gray-200 px-8 py-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                            <span onclick="router('collections')" class="hover:text-indigo-600 cursor-pointer">Collections</span>
                            <i class="fas fa-chevron-right text-xs"></i>
                            <span class="text-gray-900 font-medium" id="detailBreadcrumb">...</span>
                        </div>
                        
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-sm">
                                    <i class="fas fa-camera text-2xl"></i>
                                </div>
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-900" id="detailName">Wedding</h1>
                                    <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                                        <span id="detailDate">...</span>
                                        <span>&bull;</span>
                                        <span id="detailCount">0 items</span>
                                        <span class="px-2 py-0.5 rounded-full bg-green-100 text-green-800 text-xs font-medium">Published</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="openClientGallery()" class="btn btn-white">
                                    <i class="fas fa-external-link-alt mr-2 text-gray-400"></i> View
                                </button>
                                <button onclick="copyShareLink()" class="btn btn-white">
                                    <i class="fas fa-share mr-2 text-gray-400"></i> Share
                                </button>
                                <button onclick="openModal('uploadModal')" class="btn btn-primary shadow-lg shadow-indigo-100">
                                    <i class="fas fa-cloud-upload-alt mr-2"></i> Upload Photos
                                </button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="flex gap-8 mt-8 border-b border-gray-200 -mb-6">
                            <button class="pb-6 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">Photos</button>
                            <button class="pb-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition">Settings</button>
                            <button class="pb-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 transition">Analytics</button>
                        </div>
                    </div>
                </div>

                <!-- Detail Content -->
                <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
                    <div class="max-w-7xl mx-auto">
                        <div id="detailPhotosGrid" class="photo-grid"></div>
                        <div id="detailLoading" class="hidden py-20 text-center">
                            <i class="fas fa-circle-notch fa-spin text-3xl text-indigo-600"></i>
                            <p class="text-gray-500 mt-3">Loading photos...</p>
                        </div>
                        <div id="detailEmpty" class="hidden text-center py-20">
                            <p class="text-gray-500 mb-4">This collection is empty.</p>
                            <button onclick="openModal('uploadModal')" class="text-indigo-600 font-medium hover:underline">Upload your first photos</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VIEW: ACCOUNT -->
            <div id="view-account" class="view-section hidden p-8 max-w-7xl mx-auto">
                <h1 class="text-2xl font-bold text-gray-900 mb-4">Account Settings</h1>
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <p class="text-gray-500">Account management features are coming soon.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Create Modal -->
    <div id="createCollectionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform transition-all">
            <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-900">New Collection</h3>
                <button onclick="closeModal('createCollectionModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Collection Name</label>
                    <input type="text" id="newCollectionName" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. Smith Wedding">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="closeModal('createCollectionModal')" class="btn btn-white">Cancel</button>
                <button onclick="createCollection()" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl transform transition-all h-[80vh] flex flex-col">
            <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-900">Upload Photos</h3>
                <button onclick="closeModal('uploadModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-300 mb-3"></i>
                    <p class="font-medium text-gray-900">Click to select files</p>
                    <p class="text-sm text-gray-500 mt-1">JPG, PNG supported</p>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                </div>
                <div id="uploadList" class="mt-6 space-y-3"></div>
            </div>

            <div class="px-6 py-4 bg-gray-50 rounded-b-xl border-t border-gray-100 flex justify-between items-center">
                <span class="text-sm text-gray-500" id="uploadStatus">0 files selected</span>
                <button id="startUploadBtn" onclick="startUpload()" class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Start Upload</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 text-sm font-medium">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toastMsg">Success</span>
    </div>

<script>
    // --- Configuration ---
    const API_BASE = 'https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod';
    const COGNITO_DOMAIN = "https://ap-south-1mva8s6f3w.auth.ap-south-1.amazoncognito.com";
    const CLIENT_ID = "6j3gec3kk0q0ktkals8cr8s367";
    const REDIRECT_URI = window.location.origin + "/dashboard.html";
    let idToken = localStorage.getItem('idToken');
    
    // --- State ---
    let collections = [];
    let currentCollection = null;
    let uploadQueue = [];

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Auth Handle
        const code = new URLSearchParams(window.location.search).get('code');
        if(code) {
            try {
                const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({ grant_type: 'authorization_code', client_id: CLIENT_ID, code, redirect_uri: REDIRECT_URI })
                });
                const data = await res.json();
                if(data.id_token) {
                    idToken = data.id_token;
                    localStorage.setItem('idToken', idToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch(e) { console.error("Auth Error", e); }
        }

        if(!idToken) return window.location.href = 'login.html';
        
        // UI Setup
        try {
            const payload = JSON.parse(atob(idToken.split('.')[1]));
            document.getElementById('userName').innerText = payload.email.split('@')[0];
            document.getElementById('userAvatar').innerText = payload.email.charAt(0).toUpperCase();
        } catch(e) {}

        loadCollections();

        // Upload Handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-indigo-500'); );
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-500');
            handleFiles(e.dataTransfer.files);
        });
    });

    // --- Routing ---
    window.router = function(view, id) {
        // Safe check for elements
        ['collections', 'details', 'account'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            const nav = document.getElementById(`nav-${v}`);
            if(el) el.classList.add('hidden');
            if(nav) nav.classList.remove('active');
        });

        const target = document.getElementById(`view-${view}`);
        const targetNav = document.getElementById(`nav-${view}`);
        
        if(target) target.classList.remove('hidden');
        if(targetNav) targetNav.classList.add('active');

        if(view === 'details' && id) {
            loadCollectionDetails(id);
        } else if (view === 'collections') {
            loadCollections();
        }
    };

    // --- Logic: Collections ---
    async function loadCollections() {
        const list = document.getElementById('collectionsList');
        const empty = document.getElementById('emptyCollections');
        
        try {
            const res = await fetch(`${API_BASE}/get-collections`, { headers: { Authorization: `Bearer ${idToken}` } });
            const data = await res.json();
            collections = data.Items || [];

            if(collections.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                list.innerHTML = collections.map(c => `
                    <div onclick="router('details', '${c.collection_id}')" class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-lg transition cursor-pointer group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-xl group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i class="far fa-folder"></i>
                            </div>
                            <i class="fas fa-ellipsis-h text-gray-300 hover:text-gray-600 p-1"></i>
                        </div>
                        <h3 class="font-bold text-gray-900 truncate">${c.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${c.total_photo_count || 0} Photos &bull; ${new Date(c.created_at).toLocaleDateString()}</p>
                    </div>
                `).join('');
            }
        } catch(e) {
            console.error(e);
            list.innerHTML = '<div class="col-span-full text-center text-red-500">Failed to load collections.</div>';
        }
    }

    async function createCollection() {
        const name = document.getElementById('newCollectionName').value;
        if(!name) return showToast('Enter a name');
        try {
            await fetch(`${API_BASE}/upsert-collection`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            closeModal('createCollectionModal');
            showToast('Collection created');
            loadCollections();
        } catch(e) { showToast('Error creating'); }
    }

    // --- Logic: Details ---
    async function loadCollectionDetails(id) {
        currentCollection = collections.find(c => c.collection_id === id);
        if(!currentCollection) return router('collections');

        // Setup Header
        document.getElementById('detailBreadcrumb').innerText = currentCollection.name;
        document.getElementById('detailName').innerText = currentCollection.name;
        document.getElementById('detailDate').innerText = new Date(currentCollection.created_at).toLocaleDateString();
        document.getElementById('detailCount').innerText = `${currentCollection.total_photo_count || 0} items`;

        // Load Photos
        const grid = document.getElementById('detailPhotosGrid');
        const loader = document.getElementById('detailLoading');
        const empty = document.getElementById('detailEmpty');
        
        grid.innerHTML = '';
        grid.classList.add('hidden');
        empty.classList.add('hidden');
        loader.classList.remove('hidden');

        try {
            // Using client-api to get photos. 
            const res = await fetch(`${API_BASE}/client-api`, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_client_view', payload: { collection_id: id } })
            });
            const data = await res.json();
            const photos = data.photos || [];

            loader.classList.add('hidden');
            
            if(photos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                grid.innerHTML = photos.map(p => {
                    // Fix mixed content errors by forcing HTTPS
                    const secureThumb = p.thumb ? p.thumb.replace('http://', 'https://') : null;
                    // Fallback image if source is bad
                    const imgSrc = secureThumb || 'https://via.placeholder.com/300x300?text=No+Image';
                    
                    return `
                    <div class="photo-card">
                        <img src="${imgSrc}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x300?text=Error';">
                        <div class="photo-actions">
                            <button class="bg-white text-gray-800 w-8 h-8 rounded-full shadow hover:bg-gray-100"><i class="fas fa-search-plus"></i></button>
                            <button class="bg-white text-red-600 w-8 h-8 rounded-full shadow hover:bg-red-50"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `}).join('');
            }
        } catch(e) {
            console.error(e);
            loader.classList.add('hidden');
            grid.innerHTML = '<div class="col-span-full text-center text-red-500">Error loading photos</div>';
            grid.classList.remove('hidden');
        }
    }

    // --- Logic: Upload ---
    function handleFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(file => {
            uploadQueue.push({ file, status: 'pending', id: Math.random().toString(36).substr(2,9) });
        });
        renderUploadList();
    }

    function renderUploadList() {
        const list = document.getElementById('uploadList');
        const btn = document.getElementById('startUploadBtn');
        document.getElementById('uploadStatus').innerText = `${uploadQueue.length} files pending`;
        btn.disabled = uploadQueue.length === 0;

        list.innerHTML = uploadQueue.map(item => `
            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg text-sm">
                <span class="truncate max-w-[200px] text-gray-700">${item.file.name}</span>
                <span class="${item.status === 'done' ? 'text-green-600' : 'text-gray-400'}">
                    ${item.status === 'pending' ? '<i class="far fa-clock"></i>' : 
                      item.status === 'uploading' ? '<i class="fas fa-spinner fa-spin text-indigo-600"></i>' : 
                      '<i class="fas fa-check-circle"></i>'}
                </span>
            </div>
        `).join('');
    }

    async function startUpload() {
        if(!currentCollection) return;
        const btn = document.getElementById('startUploadBtn');
        btn.disabled = true;
        btn.innerText = "Uploading...";

        for(let item of uploadQueue) {
            if(item.status !== 'pending') continue;
            item.status = 'uploading';
            renderUploadList();

            try {
                // 1. Get Presigned URL
                const pre = await fetch(`${API_BASE}/get-upload-url`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ collection_id: currentCollection.collection_id, filename: item.file.name, content_type: item.file.type })
                });
                if(!pre.ok) throw new Error("Upload setup failed");
                const { upload_url } = await pre.json();

                // 2. Upload
                await fetch(upload_url, { method: 'PUT', headers: { 'Content-Type': item.file.type }, body: item.file });
                
                item.status = 'done';
            } catch(e) {
                console.error(e);
                item.status = 'error';
            }
            renderUploadList();
        }

        btn.innerText = "Done";
        setTimeout(() => {
            closeModal('uploadModal');
            uploadQueue = [];
            renderUploadList();
            btn.innerText = "Start Upload";
            loadCollectionDetails(currentCollection.collection_id); // Refresh view
        }, 1000);
    }

    // --- Helpers ---
    window.logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.showToast = (msg) => {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.remove('translate-y-24', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
    };
    window.openClientGallery = () => {
        if(currentCollection) window.open(`index.html?cid=${currentCollection.collection_id}`, '_blank');
    };
    window.copyShareLink = () => {
        if(!currentCollection) return;
        const url = `${window.location.origin}/index.html?cid=${currentCollection.collection_id}`;
        navigator.clipboard.writeText(url);
        showToast('Link copied!');
    };
</script>
</body>
</html>