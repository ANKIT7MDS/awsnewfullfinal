<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Dashboard â€¢ EventLens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .nav-link { @apply flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-50 hover:text-brand-600 transition-colors cursor-pointer; }
        .nav-link.active { @apply bg-brand-50 text-brand-700; }
        .tab-btn { @apply px-4 py-2 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:border-slate-300 transition-colors; }
        .tab-btn.active { @apply text-brand-600 border-brand-600; }
        .btn { @apply inline-flex items-center justify-center px-4 py-2 border text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all; }
        .btn-primary { @apply border-transparent text-white bg-brand-600 hover:bg-brand-700; }
        .btn-secondary { @apply border-slate-300 text-slate-700 bg-white hover:bg-slate-50; }
        /* Grid & Animations */
        .photo-card { @apply relative aspect-[4/3] bg-slate-100 rounded-lg overflow-hidden group cursor-pointer border border-slate-200; }
        .photo-overlay { @apply absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity p-3 flex flex-col justify-end; }
        .animate-enter { animation: enter 0.2s ease-out; }
        @keyframes enter { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-slate-100">
             <div class="flex items-center gap-2 text-brand-600">
                 <i class="fas fa-camera-retro text-2xl"></i>
                 <span class="font-bold text-lg tracking-tight text-slate-900">PhotoOwl</span>
             </div>
        </div>
        
        <div class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <div onclick="router('collections')" class="nav-link active" id="nav-collections">
                <i class="fas fa-layer-group w-5 text-center"></i> Collections
            </div>
            <div onclick="router('account')" class="nav-link" id="nav-account">
                <i class="fas fa-cog w-5 text-center"></i> Settings
            </div>
        </div>

        <div class="p-4 border-t border-slate-100">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-700 font-bold text-xs" id="userAvatar">U</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium text-slate-900 truncate" id="userName">User</p>
                    <p class="text-xs text-slate-500">Pro Plan</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full text-xs text-slate-500 hover:text-red-600 flex items-center gap-2 px-1">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 bg-slate-50/50">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30">
            <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-camera-retro text-brand-600"></i> PhotoOwl</span>
            <button onclick="logout()" class="text-slate-500"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Viewport -->
        <main class="flex-1 overflow-y-auto" id="main-container">
            
            <!-- VIEW: COLLECTIONS LIST -->
            <div id="view-collections" class="view-section p-6 md:p-10 max-w-7xl mx-auto hidden animate-enter">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Collections</h1>
                        <p class="text-sm text-slate-500 mt-1">Manage your client galleries and events.</p>
                    </div>
                    <button onclick="openModal('createCollectionModal')" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i> New Collection
                    </button>
                </div>

                <div id="collectionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="emptyCollections" class="hidden text-center py-20">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 text-2xl mx-auto mb-4"><i class="fas fa-folder-open"></i></div>
                    <h3 class="text-slate-900 font-medium">No collections yet</h3>
                    <button onclick="openModal('createCollectionModal')" class="mt-4 text-brand-600 text-sm font-medium hover:underline">Create your first collection</button>
                </div>
            </div>

            <!-- VIEW: COLLECTION DETAILS -->
            <div id="view-details" class="view-section hidden h-full flex flex-col">
                <!-- Header -->
                <div class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                    <div class="px-6 pt-6 pb-0 max-w-7xl mx-auto">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <div class="flex items-center gap-4">
                                <button onclick="router('collections')" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-arrow-left text-lg"></i></button>
                                <div>
                                    <h1 class="text-xl font-bold text-slate-900" id="detailName">Loading...</h1>
                                    <div class="flex items-center gap-4 text-xs font-medium text-slate-500 mt-1">
                                        <span><i class="fas fa-image text-brand-500 mr-1"></i> <span id="detailCount">0</span> Photos</span>
                                        <span class="hidden md:inline"><i class="fas fa-user-friends text-brand-500 mr-1"></i> <span id="detailLeads">0</span> Leads</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openClientGallery()" class="btn btn-secondary text-xs"><i class="fas fa-external-link-alt mr-2"></i> View</button>
                                <button onclick="openModal('uploadModal')" class="btn btn-primary text-xs"><i class="fas fa-cloud-upload-alt mr-2"></i> Upload</button>
                            </div>
                        </div>

                        <div class="flex gap-6 overflow-x-auto no-scrollbar">
                            <button onclick="switchDetailTab('photos')" class="tab-btn active" id="tab-photos">Photos</button>
                            <button onclick="switchDetailTab('events')" class="tab-btn" id="tab-events">Events</button>
                            <button onclick="switchDetailTab('links')" class="tab-btn" id="tab-links">Links</button>
                            <button onclick="switchDetailTab('analytics')" class="tab-btn" id="tab-analytics">Analytics</button>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                    <div class="max-w-7xl mx-auto">
                        
                        <!-- PHOTOS TAB -->
                        <div id="content-photos" class="tab-content block animate-enter">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                <div class="flex items-center gap-2 text-sm text-slate-600">
                                    <i class="fas fa-filter text-slate-400"></i> Filter:
                                </div>
                                <div class="flex flex-wrap gap-2 flex-1 justify-end">
                                    <select id="filterEvent" class="text-sm border-slate-200 rounded-md focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">All Events</option>
                                    </select>
                                    <button onclick="downloadAllPhotos()" class="btn btn-secondary h-9 px-3 text-xs"><i class="fas fa-download mr-1"></i> Zip</button>
                                </div>
                            </div>

                            <div id="detailPhotosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
                            <div id="detailLoading" class="text-center py-20 text-slate-400 hidden"><i class="fas fa-circle-notch fa-spin text-2xl"></i></div>
                            <div id="detailEmpty" class="text-center py-20 hidden">
                                <p class="text-slate-500 mb-2">No photos found.</p>
                                <button onclick="openModal('uploadModal')" class="text-brand-600 text-sm font-medium">Upload Now</button>
                            </div>
                        </div>

                        <!-- EVENTS TAB -->
                        <div id="content-events" class="tab-content hidden animate-enter">
                            <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="font-medium text-slate-900">Sub-Events</h3>
                                    <button onclick="openModal('eventModal')" class="btn btn-primary text-xs px-2 py-1">Add Event</button>
                                </div>
                                <table class="min-w-full divide-y divide-slate-100">
                                    <thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Count</th><th class="px-6 py-3 text-right"></th></tr></thead>
                                    <tbody id="eventsList" class="divide-y divide-slate-100 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- LINKS TAB -->
                        <div id="content-links" class="tab-content hidden animate-enter max-w-2xl mx-auto">
                            <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-6">
                                <h3 class="font-bold text-slate-900 mb-2">Generate Search Link</h3>
                                <p class="text-sm text-slate-500 mb-6">Create a unique link filtered by event.</p>
                                <div class="space-y-4">
                                    <select id="linkEventSelect" class="w-full border-slate-300 rounded-md text-sm"><option value="">All Events</option></select>
                                    <button onclick="generateLink()" class="btn btn-primary w-full">Generate</button>
                                    <div id="linkResult" class="hidden mt-4 p-3 bg-slate-50 rounded border border-slate-200 flex gap-2">
                                        <input type="text" id="generatedLinkInput" readonly class="flex-1 bg-transparent text-sm text-slate-600 outline-none">
                                        <button onclick="copyGeneratedLink()" class="text-brand-600 hover:text-brand-700 font-medium text-sm">Copy</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ANALYTICS TAB -->
                        <div id="content-analytics" class="tab-content hidden animate-enter">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                                    <p class="text-xs font-bold text-slate-400 uppercase">Leads</p>
                                    <p class="text-3xl font-bold text-slate-800 mt-2" id="statLeads">0</p>
                                </div>
                                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                                    <p class="text-xs font-bold text-slate-400 uppercase">Storage</p>
                                    <p class="text-3xl font-bold text-slate-800 mt-2" id="statStorage">0 MB</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- VIEW: ACCOUNT -->
            <div id="view-account" class="view-section hidden p-10 max-w-3xl mx-auto animate-enter">
                <h1 class="text-2xl font-bold text-slate-900 mb-6">Settings</h1>
                <div class="bg-white rounded-lg border border-slate-200 p-8 text-center">
                    <p class="text-slate-500">Account management features coming soon.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->
    <!-- Create Collection -->
    <div id="createCollectionModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-enter">
            <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">New Collection</h3>
                <button onclick="closeModal('createCollectionModal')" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5">
                <label class="block text-sm font-medium text-slate-700 mb-1">Collection Name</label>
                <input type="text" id="newCollectionName" class="w-full border-slate-300 rounded-md focus:ring-brand-500 focus:border-brand-500">
            </div>
            <div class="px-5 py-4 bg-slate-50 flex justify-end gap-2">
                <button onclick="closeModal('createCollectionModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="createCollection()" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Event -->
    <div id="eventModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-enter">
            <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Add Sub-Event</h3>
                <button onclick="closeModal('eventModal')" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5">
                <label class="block text-sm font-medium text-slate-700 mb-1">Event Name</label>
                <input type="text" id="subEventName" placeholder="e.g. Reception" class="w-full border-slate-300 rounded-md focus:ring-brand-500 focus:border-brand-500">
            </div>
            <div class="px-5 py-4 bg-slate-50 flex justify-end gap-2">
                <button onclick="closeModal('eventModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="createSubEvent()" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>

    <!-- Upload -->
    <div id="uploadModal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col animate-enter">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Upload Photos</h3>
                <button onclick="closeModal('uploadModal')" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-brand-500 hover:bg-brand-50 transition cursor-pointer mb-6">
                    <div class="text-brand-500 text-3xl mb-3"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p class="font-medium text-slate-900">Click or Drag photos here</p>
                    <p class="text-sm text-slate-500 mt-1">JPG, PNG, HEIC supported</p>
                    <input type="file" id="fileInput" multiple accept="image/*,.heic" class="hidden">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Assign to Event</label>
                    <select id="uploadEventSelect" class="w-full border-slate-300 rounded-md text-sm"><option value="">Main Collection</option></select>
                </div>
                <div id="uploadList" class="space-y-2"></div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                <span class="text-sm text-slate-500" id="uploadStatus"></span>
                <button id="startUploadBtn" onclick="startUpload()" class="btn btn-primary" disabled>Start Upload</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fas fa-info-circle text-brand-400"></i>
        <span id="toastMsg" class="font-medium text-sm"></span>
    </div>

<script>
    const API_BASE = 'https://oel3deh9q3.execute-api.ap-south-1.amazonaws.com/prod';
    const COGNITO_DOMAIN = "https://ap-south-1mva8s6f3w.auth.ap-south-1.amazoncognito.com";
    const CLIENT_ID = "6j3gec3kk0q0ktkals8cr8s367";
    const REDIRECT_URI = window.location.origin + "/dashboard.html";
    
    let idToken = localStorage.getItem('idToken');
    let collections = [], currentCollection = null, currentPhotos = [], uploadQueue = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const code = new URLSearchParams(window.location.search).get('code');
        if(code) {
            try {
                const res = await fetch(`${COGNITO_DOMAIN}/oauth2/token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({ grant_type: 'authorization_code', client_id: CLIENT_ID, code, redirect_uri: REDIRECT_URI })
                });
                const data = await res.json();
                if(data.id_token) {
                    idToken = data.id_token;
                    localStorage.setItem('idToken', idToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch(e) {}
        }

        if(!idToken) return window.location.href = 'login.html';
        
        try {
            const payload = JSON.parse(atob(idToken.split('.')[1]));
            document.getElementById('userName').innerText = payload.email.split('@')[0];
            document.getElementById('userAvatar').innerText = payload.email.charAt(0).toUpperCase();
        } catch(e) {}

        router('collections');

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-500', 'bg-brand-50'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-brand-500', 'bg-brand-50'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-brand-500', 'bg-brand-50'); handleFiles(e.dataTransfer.files); });
    });

    window.router = function(view, id) {
        ['collections', 'details', 'account'].forEach(v => {
            const el = document.getElementById(`view-${v}`);
            const nav = document.getElementById(`nav-${v}`);
            if(el) el.classList.add('hidden');
            if(nav) nav.classList.remove('active');
        });
        document.getElementById(`view-${view}`).classList.remove('hidden');
        const nav = document.getElementById(`nav-${view}`);
        if(nav) nav.classList.add('active');

        if(view === 'details' && id) loadCollectionDetails(id);
        else if (view === 'collections') loadCollections();
    };

    window.switchDetailTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`content-${tab}`).classList.remove('hidden');
    };

    async function loadCollections() {
        const list = document.getElementById('collectionsList');
        const empty = document.getElementById('emptyCollections');
        list.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-circle-notch fa-spin text-brand-500"></i></div>';
        try {
            const res = await fetch(`${API_BASE}/get-collections`, { headers: { Authorization: `Bearer ${idToken}` } });
            const data = await res.json();
            collections = data.Items || [];
            list.innerHTML = '';
            if(collections.length === 0) empty.classList.remove('hidden');
            else {
                empty.classList.add('hidden');
                list.innerHTML = collections.map(c => `
                    <div onclick="router('details', '${c.collection_id}')" class="bg-white rounded-lg border border-slate-200 p-5 hover:shadow-lg transition cursor-pointer group">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 bg-brand-50 text-brand-600 rounded-lg flex items-center justify-center text-lg"><i class="fas fa-folder"></i></div>
                            <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600 font-medium">${c.total_photo_count || 0} Photos</span>
                        </div>
                        <h3 class="font-bold text-slate-900 truncate">${c.name}</h3>
                        <p class="text-sm text-slate-500 mt-1">${new Date(c.created_at).toLocaleDateString()}</p>
                    </div>
                `).join('');
            }
        } catch(e) { list.innerHTML = '<div class="text-red-500 text-center col-span-full">Failed to load data</div>'; }
    }

    async function createCollection() {
        const name = document.getElementById('newCollectionName').value;
        if(!name) return showToast('Name is required');
        try {
            await fetch(`${API_BASE}/upsert-collection`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            closeModal('createCollectionModal');
            showToast('Collection created');
            loadCollections();
        } catch(e) { showToast('Creation failed'); }
    }

    async function loadCollectionDetails(id) {
        currentCollection = collections.find(c => c.collection_id === id);
        if(!currentCollection) return router('collections');
        document.getElementById('detailName').innerText = currentCollection.name;
        document.getElementById('detailCount').innerText = currentCollection.total_photo_count || 0;
        switchDetailTab('photos');
        loadPhotos();
    }

    async function loadPhotos() {
        const grid = document.getElementById('detailPhotosGrid');
        const loader = document.getElementById('detailLoading');
        const empty = document.getElementById('detailEmpty');
        grid.innerHTML = '';
        grid.classList.add('hidden');
        empty.classList.add('hidden');
        loader.classList.remove('hidden');

        try {
            const res = await fetch(`${API_BASE}/client-api`, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_client_view', payload: { collection_id: currentCollection.collection_id } })
            });
            const data = await res.json();
            currentPhotos = data.photos || [];
            loader.classList.add('hidden');
            if(currentPhotos.length === 0) empty.classList.remove('hidden');
            else {
                grid.classList.remove('hidden');
                renderPhotoGrid(currentPhotos);
            }
            populateEventFilter();
            // Stats
            const size = currentPhotos.reduce((a,b) => a + (b.size || 1024*1024*2), 0);
            document.getElementById('statStorage').innerText = formatBytes(size);
        } catch(e) { loader.classList.add('hidden'); empty.classList.remove('hidden'); }
    }

    function renderPhotoGrid(photos) {
        const grid = document.getElementById('detailPhotosGrid');
        grid.innerHTML = photos.map(p => {
             // CRITICAL FIX: Robust property access for image URL
             let src = p.thumbnail_url || p.thumb || p.url || p.full_url;
             if(src && src.startsWith('http://')) src = src.replace('http://', 'https://');
             
             // If no source found, use placeholder
             if(!src) src = 'https://via.placeholder.com/400?text=No+Image';

             return `
                <div class="photo-card" onclick="window.open('${src}', '_blank')">
                    <img src="${src}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" onerror="this.src='https://via.placeholder.com/400?text=Error'">
                    <div class="photo-overlay">
                        <span class="text-xs bg-black/60 text-white px-2 py-1 rounded inline-block w-max backdrop-blur-sm">${p.event || 'Main'}</span>
                    </div>
                </div>
             `;
        }).join('');
    }

    function populateEventFilter() {
        const select = document.getElementById('filterEvent');
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        select.innerHTML = '<option value="">All Events</option>' + events.map(e => `<option value="${e}">${e}</option>`).join('');
        select.onchange = () => {
            const val = select.value;
            renderPhotoGrid(val ? currentPhotos.filter(p => (p.event || 'Main Event') === val) : currentPhotos);
        };
    }

    async function createSubEvent() {
        const name = document.getElementById('subEventName').value;
        if(name) {
            showToast(`Event "${name}" added`);
            closeModal('eventModal');
            // Force refresh of upload dropdowns if open
            const select = document.getElementById('uploadEventSelect');
            if(select) {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                select.appendChild(opt);
                select.value = name;
            }
        }
    }

    function generateLink() {
        const evt = document.getElementById('linkEventSelect').value;
        const link = `${window.location.origin}/index.html?cid=${currentCollection.collection_id}${evt ? '&event='+encodeURIComponent(evt) : ''}`;
        document.getElementById('generatedLinkInput').value = link;
        document.getElementById('linkResult').classList.remove('hidden');
    }

    function copyGeneratedLink() {
        const input = document.getElementById('generatedLinkInput');
        input.select();
        document.execCommand('copy');
        showToast('Copied!');
    }

    function handleFiles(files) {
        if(!files.length) return;
        const events = [...new Set(currentPhotos.map(p => p.event || 'Main Event'))];
        const select = document.getElementById('uploadEventSelect');
        if(select.options.length <= 1) select.innerHTML = '<option value="">Main Collection</option>' + events.map(e => `<option value="${e}">${e}</option>`).join('');

        Array.from(files).forEach(file => {
            uploadQueue.push({ file, status: 'pending', id: Math.random().toString(36).substr(2,9) });
        });
        renderUploadList();
    }

    function renderUploadList() {
        const list = document.getElementById('uploadList');
        const btn = document.getElementById('startUploadBtn');
        document.getElementById('uploadStatus').innerText = `${uploadQueue.length} files queued`;
        btn.disabled = uploadQueue.length === 0;
        list.innerHTML = uploadQueue.map(item => `
            <div class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 text-sm">
                <span class="truncate max-w-[200px] text-slate-700">${item.file.name}</span>
                <span class="${item.status === 'done' ? 'text-green-600' : 'text-slate-400'}">
                    ${item.status === 'pending' ? '<i class="far fa-clock"></i>' : 
                      item.status === 'converting' ? '<i class="fas fa-cog fa-spin text-orange-500"></i>' :
                      item.status === 'uploading' ? '<i class="fas fa-spinner fa-spin text-brand-500"></i>' : 
                      '<i class="fas fa-check-circle"></i>'}
                </span>
            </div>
        `).join('');
    }

    async function startUpload() {
        const btn = document.getElementById('startUploadBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";
        const evt = document.getElementById('uploadEventSelect').value;

        for(let item of uploadQueue) {
            if(item.status !== 'pending') continue;
            let fileToUpload = item.file;
            let filename = item.file.name;
            let contentType = item.file.type;

            if(filename.toLowerCase().endsWith('.heic')) {
                item.status = 'converting';
                renderUploadList();
                try {
                    const blob = await heic2any({ blob: item.file, toType: "image/jpeg", quality: 0.8 });
                    fileToUpload = blob;
                    filename = filename.replace(/\.heic$/i, ".jpg");
                    contentType = "image/jpeg";
                } catch(e) { item.status = 'error'; renderUploadList(); continue; }
            }

            item.status = 'uploading';
            renderUploadList();

            try {
                const pre = await fetch(`${API_BASE}/get-upload-url`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${idToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ collection_id: currentCollection.collection_id, filename: filename, content_type: contentType, event: evt })
                });
                if(!pre.ok) throw new Error("Pre-sign failed");
                const { upload_url } = await pre.json();
                await fetch(upload_url, { method: 'PUT', headers: { 'Content-Type': contentType }, body: fileToUpload });
                item.status = 'done';
            } catch(e) { item.status = 'error'; }
            renderUploadList();
        }
        btn.innerText = "Done";
        setTimeout(() => {
            closeModal('uploadModal');
            uploadQueue = [];
            renderUploadList();
            btn.innerText = "Start Upload";
            loadPhotos();
        }, 1000);
    }

    async function downloadAllPhotos() {
        if(currentPhotos.length === 0) return showToast("No photos");
        showToast("Starting Download...");
        try {
            await fetch(currentPhotos[0].thumbnail_url || currentPhotos[0].url, { method: 'HEAD' });
            const zip = new JSZip();
            const folder = zip.folder(currentCollection.name || "Photos");
            const limit = Math.min(currentPhotos.length, 50);
            
            for(let i=0; i<limit; i++) {
                const p = currentPhotos[i];
                const src = p.url || p.thumbnail_url;
                if(src) {
                    const blob = await fetch(src).then(r => r.blob());
                    folder.file(`photo_${i+1}.jpg`, blob);
                }
            }
            zip.generateAsync({type:"blob"}).then(c => { saveAs(c, `${currentCollection.name}.zip`); showToast("Complete!"); });
        } catch(e) {
            console.error("CORS Error", e);
            alert("Security Block: Images are on S3 without CORS. Opening images in new tabs instead.");
            currentPhotos.slice(0, 5).forEach(p => window.open(p.url || p.thumbnail_url, '_blank'));
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.showToast = (msg) => {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.remove('translate-y-24', 'opacity-0');
        setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
    };
    window.openClientGallery = () => {
        if(currentCollection) window.open(`index.html?cid=${currentCollection.collection_id}`, '_blank');
    };
    window.copyShareLink = () => {
        if(!currentCollection) return;
        const url = `${window.location.origin}/index.html?cid=${currentCollection.collection_id}`;
        navigator.clipboard.writeText(url);
        showToast('Link Copied!');
    };
</script>
</body>
</html>